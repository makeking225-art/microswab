<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Microswab Groups</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:#f0f2f5;color:#050505;}
.header{background:#fff;padding:15px;font-size:20px;font-weight:700;text-align:center;border-bottom:1px solid #ddd;}
.main{max-width:500px;margin:auto;padding:15px;}
.create-card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px;}
.create-card button{width:100%;padding:12px;background:#1877f2;border:none;color:#fff;border-radius:8px;font-size:16px;}
#create-form{display:none;background:#fff;padding:15px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:20px;}
#create-form h3{margin-top:0;}
input,textarea,select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;font-size:14px;}
#create-form button{width:100%;padding:12px;border:none;border-radius:8px;background:#1877f2;color:#fff;font-size:16px;}
.preview{width:100%;height:180px;border-radius:10px;background:#e4e6eb;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:10px;}
.preview img{width:100%;height:100%;object-fit:cover;}
.groups{display:flex;flex-direction:column;gap:12px;}
.group{background:#fff;border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:pointer;position:relative;}
.group img{width:60px;height:60px;border-radius:12px;object-fit:cover;}
.group-info{flex:1;}
.group-info h4{margin:0;font-size:15px;}
.group-info span{font-size:12px;color:#65676b;}
.group button{background:#e4e6eb;border:none;padding:8px 12px;border-radius:8px;}
.group-options{position:absolute;top:10px;right:10px;background:#e4e6eb;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-weight:bold;}
.bottom-nav {position: fixed;bottom: 0;left: 0;width: 100%;height: 60px;background: #ffffff;border-top: 1px solid #ddd;display: flex;justify-content: space-around;align-items: center;z-index: 1000;}
.bottom-nav a {text-decoration: none;color: #666;font-size: 11px;display: flex;flex-direction: column;align-items: center;}
.bottom-nav a span {font-size: 22px;margin-bottom: 2px;}
.bottom-nav a.active {color: #0088cc;}
#messageList {padding-bottom: 70px;}

/* ===== DELETE MODAL ===== */
#deleteModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:500;}
#deleteModal .modal-content{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px;text-align:center;}
#deleteModal button{padding:10px 20px;background:#e53935;color:white;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>

<div class="header">Microswab Groups</div>

<div class="main">

  <!-- CREATE -->
  <div class="create-card">
    <button id="openCreate">+ Create Group</button>
  </div>

  <!-- FORM -->
  <div id="create-form">
    <h3>Create Group</h3>
    <div class="preview" id="previewBox"><span>Select group image</span></div>
    <input type="file" id="imageInput" accept="image/*">
    <input type="text" id="name" placeholder="Group name">
    <textarea id="desc" placeholder="Group description"></textarea>
    <select id="privacy">
      <option value="Public">Public group</option>
      <option value="Private">Private group</option>
    </select>
    <button id="createGroup">Create Group</button>
  </div>

  <!-- ALL GROUPS -->
  <div class="groups" id="groups"></div>

  <!-- USER'S JOINED GROUPS -->
  <h3 style="margin-top:20px;">Your Joined Groups</h3>
  <div class="groups" id="joinedGroups"></div>

</div>

<!-- DELETE MODAL -->
<div id="deleteModal">
  <div class="modal-content">
    <p>Are you sure you want to delete this group?</p>
    <button id="confirmDeleteBtn">Yes</button>
  </div>
</div>
<!-- PAYMENT MODAL -->
<div id="paymentModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;
background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:600;">
  <div style="background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px;text-align:center;">
    <p id="paymentMessage">To join this group you need to pay 15 tokens</p>
    <button id="payNowBtn" style="padding:10px 20px;background:#1877f2;color:white;border:none;border-radius:8px;margin-top:10px;">Pay Now</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBdF5IFp9MblVQ2GUvE2NC8TsgTpVuT7dM",
  authDomain:"vs-code-d4d6b.firebaseapp.com",
  projectId:"vs-code-d4d6b",
  storageBucket:"vs-code-d4d6b.appspot.com",
  messagingSenderId:"1012283563694",
  appId:"1:1012283563694:web:f25cfd82e9f762f617d73f"
});
const db=firebase.firestore();
const auth=firebase.auth();

const openBtn=document.getElementById("openCreate");
const form=document.getElementById("create-form");
openBtn.onclick=()=>form.style.display="block";

/* IMAGE UPLOAD */
let imageURL="";
const cloud="dcpa8046h";
const preset="microswab-profile";
const input=document.getElementById("imageInput");
const preview=document.getElementById("previewBox");

input.onchange=async()=>{
  const file=input.files[0];
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",preset);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${cloud}/image/upload`,{method:"POST",body:fd});
  const d=await r.json();
  imageURL=d.secure_url;
  preview.innerHTML=`<img src="${imageURL}">`;
};

/* CREATE GROUP */
document.getElementById("createGroup").onclick=async()=>{
  const name=document.getElementById("name").value;
  const desc=document.getElementById("desc").value;
  const privacy=document.getElementById("privacy").value;
  if(!name||!imageURL) return alert("Fill all fields");

  const user=auth.currentUser;
  if(!user) return alert("Login required");

  await db.collection("groups").add({
    name,desc,privacy,imageURL,
    owner:user.uid,
    members:[user.uid],
    created:firebase.firestore.FieldValue.serverTimestamp()
  });

  form.style.display="none";
  document.getElementById("name").value="";
  document.getElementById("desc").value="";
  input.value="";
  preview.innerHTML=`<span>Select group image</span>`;
};

/* DELETE GROUP MODAL */
const deleteModal=document.getElementById("deleteModal");
const confirmDeleteBtn=document.getElementById("confirmDeleteBtn");
let groupToDeleteId=null;

/* LOAD GROUPS */
const groupsDiv=document.getElementById("groups");
const joinedDiv=document.getElementById("joinedGroups");

auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");

  db.collection("groups").orderBy("created","desc")
  .onSnapshot(s=>{
    groupsDiv.innerHTML="";
    joinedDiv.innerHTML="";
    s.forEach(d=>{
      const g=d.data();
      const id=d.id;
      const isJoined=g.members?.includes(user.uid);

      const groupEl=document.createElement("div");
      groupEl.className="group";
      groupEl.innerHTML=`
        <img src="${g.imageURL}">
        <div class="group-info">
          <h4>${g.name}</h4>
          <span>${g.privacy} Â· Microswab</span>
        </div>
        <button>${isJoined ? "Joined" : "Join"}</button>
      `;

      const btn=groupEl.querySelector("button");
      btn.onclick=async(e)=>{
        e.stopPropagation();
        if(isJoined) return;
        await db.collection("groups").doc(id).update({
          members:firebase.firestore.FieldValue.arrayUnion(user.uid)
        });
      };

      groupEl.onclick = async (e) => {
  e.stopPropagation(); // prevent double clicks
  const groupRef = db.collection("groups").doc(id);
  const groupSnap = await groupRef.get();
  const groupData = groupSnap.data();
  const ownerId = groupData.owner;

  // Skip payment if user is owner or already joined
  if (user.uid === ownerId || groupData.members.includes(user.uid)) {
    window.location.href = `gromess.html?groupId=${id}`;
    return;
  }

  // Show payment modal
  const paymentModal = document.getElementById("paymentModal");
  const payNowBtn = document.getElementById("payNowBtn");
  const paymentMessage = document.getElementById("paymentMessage");
  paymentModal.style.display = "flex";

  payNowBtn.onclick = async () => {
    const userRef = db.collection("users").doc(user.uid);
    const teacherRef = db.collection("users").doc(ownerId);
    const userSnap = await userRef.get();
    const userData = userSnap.data();
    const userTokens = userData.tokens || 0;

    if (userTokens >= 15) {
      // Deduct 15 tokens from user
      await userRef.update({ tokens: firebase.firestore.FieldValue.increment(-15) });
      // Add 15 tokens to teacher
      await teacherRef.update({ tokens: firebase.firestore.FieldValue.increment(15) });
      // Add user to group members
      await groupRef.update({ members: firebase.firestore.FieldValue.arrayUnion(user.uid) });
      // Add notification to teacher
      await db.collection("users").doc(ownerId).collection("notifications").add({
        message: `${userData.displayName || 'A user'} sent you 15 tokens to join your group! ðŸŽ‰`,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      paymentMessage.textContent = "Payment successful ðŸŽ‰";
      payNowBtn.textContent = "OK";

      payNowBtn.onclick = () => {
        paymentModal.style.display = "none";
        window.location.href = `gromess.html?groupId=${id}`;
      };
    } else {
      paymentMessage.textContent = "Your tokens balance is insufficient. Please earn more.";
      payNowBtn.textContent = "OK";
      payNowBtn.onclick = () => {
        paymentModal.style.display = "none";
      };
    }
  };
};

      // ===== ONLY OWNER SEES 3 DOTS =====
      if(user.uid === g.owner){
        const optionsBtn=document.createElement("button");
        optionsBtn.className="group-options";
        optionsBtn.textContent="â‹®";
        groupEl.appendChild(optionsBtn);

        optionsBtn.onclick=(e)=>{
          e.stopPropagation(); // prevent opening group
          groupToDeleteId=id;
          deleteModal.style.display="flex"; // show modal
        };
      }

      if(isJoined){
        joinedDiv.appendChild(groupEl);
      } else {
        groupsDiv.appendChild(groupEl);
      }
    });
  });
});

/* DELETE CONFIRM */
confirmDeleteBtn.onclick=async()=>{
  if(groupToDeleteId){
    await db.collection("groups").doc(groupToDeleteId).delete();
    deleteModal.style.display="none";
    groupToDeleteId=null;
  }
};

/* CLOSE MODAL ON CLICK OUTSIDE */
deleteModal.onclick=e=>{
  if(e.target===deleteModal){
    deleteModal.style.display="none";
    groupToDeleteId=null;
  }
};
</script>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <a href="home.html" class="active">
    <span class="material-icons-outlined">home</span>
    Home
  </a>
  <a href="messages.html">
    <span class="material-icons-outlined">chat_bubble_outline</span>
    learning
  </a>
  <a href="add.html">
    <span class="material-icons plus-button">add</span>
    Add
  </a>
  <a href="reels.html" class="reels-btn">
    <span class="material-icons-outlined">video_library</span>
    videos
  </a>
  <a href="profile.html">
    <span class="material-icons-outlined">person</span>
    Profile
  </a>
</div>

</body>
</html>